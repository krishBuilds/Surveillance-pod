{% extends "layout.html" %}

{% block title %}InternVideo2.5 Surveillance{% endblock %}

{% block content %}
    <!-- Main Content Area -->
    <div id="main-content">
        <!-- Caption Generation Page (Default) -->
        <div id="caption-page" class="page-section">
            {% include "pages/caption.html" %}
        </div>

        <!-- Video Analysis Page -->
        <div id="analysis-page" class="page-section hidden">
            {% include "pages/analysis.html" %}
        </div>
    </div>

    <!-- Global notifications area -->
    <div id="notifications" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;"></div>
{% endblock %}

{% block extra_css %}
<style>
/* Page-specific styles */
.notification {
    padding: 1rem 1.5rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.notification-success {
    background-color: #dcfce7;
    color: #166534;
    border-left: 4px solid #10b981;
}

.notification-error {
    background-color: #fee2e2;
    color: #991b1b;
    border-left: 4px solid #ef4444;
}

.notification-warning {
    background-color: #fef3c7;
    color: #92400e;
    border-left: 4px solid #f59e0b;
}

.notification-info {
    background-color: #dbeafe;
    color: #1e40af;
    border-left: 4px solid #2563eb;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Enhanced video player */
.video-container {
    position: relative;
}

.video-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    padding: 1rem;
    color: white;
}

/* Loading states */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 100;
}

/* Responsive grid adjustments */
@media (max-width: 1024px) {
    .grid-3 {
        grid-template-columns: 1fr 1fr;
    }
    
    .grid-4 {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 640px) {
    .grid-3, .grid-4 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize notification system
    window.showNotification = function(message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = message;
        
        const container = document.querySelector('#notifications');
        container.appendChild(notification);
        
        // Auto-remove
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }, duration);
        
        // Click to dismiss
        notification.addEventListener('click', () => {
            notification.remove();
        });
    };

    // Enhanced video player controls
    const videoPlayer = document.querySelector('#video-player');
    if (videoPlayer) {
        videoPlayer.addEventListener('loadstart', () => {
            console.log('Video loading started');
        });
        
        videoPlayer.addEventListener('canplay', () => {
            console.log('Video can start playing');
            window.showNotification('Video ready for playback', 'success');
        });
        
        videoPlayer.addEventListener('error', (e) => {
            console.error('Video error:', e);
            window.showNotification('Video playback error', 'error');
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter to send chat message
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const chatForm = document.querySelector('#chat-form');
            if (chatForm && !document.querySelector('#message-input').disabled) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
        
        // ESC to clear current input
        if (e.key === 'Escape') {
            const messageInput = document.querySelector('#message-input');
            if (messageInput && messageInput.value) {
                messageInput.value = '';
            }
        }
    });

    // Auto-save form data
    const formInputs = document.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        // Load saved value
        const savedValue = localStorage.getItem(`form_${input.id}`);
        if (savedValue && input.type !== 'file') {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = savedValue === 'true';
            } else {
                input.value = savedValue;
            }
        }
        
        // Save on change
        input.addEventListener('change', () => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                localStorage.setItem(`form_${input.id}`, input.checked.toString());
            } else {
                localStorage.setItem(`form_${input.id}`, input.value);
            }
        });
    });

  
    // Performance monitoring
    let performanceData = {
        pageLoadTime: performance.now(),
        interactions: 0
    };

    document.addEventListener('click', () => {
        performanceData.interactions++;
    });

    // Send performance data periodically (mock)
    setInterval(() => {
        console.log('Performance metrics:', {
            ...performanceData,
            uptime: performance.now() - performanceData.pageLoadTime
        });
    }, 30000);
});

// Global utility functions
window.formatTime = function(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
};

window.formatFileSize = function(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};

// Video selection and preview functionality
window.setupVideoPreview = function() {
    // Caption page video selection
    const captionVideoSelect = document.getElementById('caption-video-select');
    const captionVideoPreview = document.getElementById('caption-video-preview');
    const captionPreviewPlayer = document.getElementById('caption-preview-player');
    
    if (captionVideoSelect) {
        captionVideoSelect.addEventListener('change', function() {
            const selectedVideo = this.value;
            if (selectedVideo) {
                // Show video preview
                captionVideoPreview.classList.remove('hidden');
                captionPreviewPlayer.src = `/serve-video/${selectedVideo}`;
                captionPreviewPlayer.load();
                
                // Hide empty state, show results area (but not processing progress)
                document.getElementById('empty-state').classList.add('hidden');
                const resultsDiv = document.getElementById('caption-results');
                if (resultsDiv) {
                    resultsDiv.classList.remove('hidden');
                }
            } else {
                // Hide video preview
                captionVideoPreview.classList.add('hidden');
                captionPreviewPlayer.src = '';
                
                // Show empty state
                const emptyState = document.getElementById('empty-state');
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }
                const resultsDiv = document.getElementById('caption-results');
                if (resultsDiv) {
                    resultsDiv.classList.add('hidden');
                }
            }
        });
    }
    
    // Analysis page video selection
    const analysisVideoSelect = document.getElementById('video-selector');
    const analysisVideoPreview = document.getElementById('analysis-video-preview');
    const analysisPreviewPlayer = document.getElementById('analysis-preview-player');
    
    if (analysisVideoSelect) {
        analysisVideoSelect.addEventListener('change', function() {
            const selectedVideo = this.value;
            if (selectedVideo) {
                // Show video preview
                analysisVideoPreview.classList.remove('hidden');
                analysisPreviewPlayer.src = `/serve-video/${selectedVideo}`;
                analysisPreviewPlayer.load();
                
                // Enable analyze button
                document.getElementById('analyze-chunks-btn').disabled = false;
                
                // Show video info and results
                document.getElementById('video-info-display').classList.remove('hidden');
                document.getElementById('analysis-empty-state').classList.add('hidden');
                document.getElementById('chunk-analysis-results').classList.remove('hidden');
            } else {
                // Hide video preview
                analysisVideoPreview.classList.add('hidden');
                analysisPreviewPlayer.src = '';
                
                // Disable analyze button
                document.getElementById('analyze-chunks-btn').disabled = true;
                
                // Hide video info and results
                document.getElementById('video-info-display').classList.add('hidden');
                document.getElementById('analysis-empty-state').classList.remove('hidden');
                document.getElementById('chunk-analysis-results').classList.add('hidden');
            }
        });
    }
};

// Chunk display functions
window.displayChunks = function(chunks) {
    const container = document.getElementById('chunks-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    chunks.forEach((chunk, index) => {
        const chunkElement = document.createElement('div');
        chunkElement.className = 'border-bottom p-2';
        chunkElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="badge bg-primary">Chunk ${index + 1}</span>
                <small class="text-muted">${window.formatTime(chunk.start_time)} - ${window.formatTime(chunk.end_time)}</small>
            </div>
            <div class="small">${chunk.caption || chunk.text || 'No caption available'}</div>
        `;
        container.appendChild(chunkElement);
    });
};

window.copyAllChunks = function() {
    const chunks = document.querySelectorAll('#chunks-container > div');
    let allText = '';
    chunks.forEach(chunk => {
        allText += chunk.textContent.trim() + '\n\n';
    });
    
    if (allText) {
        navigator.clipboard.writeText(allText).then(() => {
            showNotification('All chunks copied to clipboard!', 'success');
        });
    }
};

window.downloadAllChunks = function() {
    const chunks = document.querySelectorAll('#chunks-container > div');
    let allText = '';
    chunks.forEach(chunk => {
        allText += chunk.textContent.trim() + '\n\n';
    });
    
    if (allText) {
        const blob = new Blob([allText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'video_chunks.txt';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Chunks downloaded!', 'success');
    }
};

window.copyToClipboard = function(text) {
    // Decode HTML entities
    const decodedText = text.replace(/&apos;/g, "'").replace(/&quot;/g, '"');
    navigator.clipboard.writeText(decodedText).then(() => {
        window.showNotification('Copied to clipboard!', 'success', 2000);
    }).catch(() => {
        window.showNotification('Failed to copy to clipboard', 'error');
    });
};

window.downloadCaptionFile = function(videoFile, caption) {
    // Decode HTML entities
    const decodedCaption = caption.replace(/&apos;/g, "'").replace(/&quot;/g, '"');
    const blob = new Blob([decodedCaption], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${videoFile}_caption.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    window.showNotification('Caption downloaded!', 'success', 2000);
};
</script>
{% endblock %}