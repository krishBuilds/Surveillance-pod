<!-- Video Analysis Page -->
<div id="analysis-page" class="page-content hidden">
    <div class="page-header">
        <h1 class="page-title">Video Analysis Dashboard</h1>
        <p class="page-description">
            Advanced analytics and insights for processed videos with temporal visualization
        </p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div style="font-size: 2rem; color: var(--primary-color);">
                    <i class="fas fa-video"></i>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;" id="total-videos">
                    0
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    Videos Processed
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body text-center">
                <div style="font-size: 2rem; color: var(--accent-color);">
                    <i class="fas fa-clock"></i>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;" id="total-duration">
                    0m
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    Total Duration
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body text-center">
                <div style="font-size: 2rem; color: var(--warning-color);">
                    <i class="fas fa-images"></i>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;" id="total-frames">
                    0
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    Frames Analyzed
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body text-center">
                <div style="font-size: 2rem; color: var(--danger-color);">
                    <i class="fas fa-comments"></i>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;" id="total-queries">
                    0
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    Chat Queries
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-2">
        <!-- Processing History -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-history nav-icon"></i>
                    Processing History
                </div>
                <div class="card-subtitle">Recent video processing sessions</div>
            </div>
            <div class="card-body">
                <div id="processing-history">
                    <div class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                        <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">No processing history yet</p>
                        <p style="font-size: 0.875rem;">Process a video to see analytics here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-tachometer-alt nav-icon"></i>
                    Performance Metrics
                </div>
                <div class="card-subtitle">System performance analytics</div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>GPU Utilization</span>
                        <span id="gpu-utilization">88%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 88%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Memory Usage</span>
                        <span id="memory-usage">20.86GB / 24GB</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 87%"></div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div style="text-align: center; padding: 1rem; background-color: var(--secondary-color); border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">4.9</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Frames/sec</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background-color: var(--secondary-color); border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent-color);">16s</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Model Load</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chunk Relevance Analyzer -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-search nav-icon"></i>
                Chunk Relevance Analyzer
            </div>
            <div class="card-subtitle">Find the most relevant video chunk for your investigation query</div>
        </div>
        <div class="card-body">
            <div class="grid grid-2">
                <!-- Input Section -->
                <div>
                    <div class="form-group mb-3">
                        <label class="form-label">Select Video</label>
                        <select id="video-selector" class="form-input">
                            <option value="">Select a video with stored captions...</option>
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Investigation Query</label>
                        <textarea 
                            id="chunk-query" 
                            class="form-input" 
                            placeholder="Enter your investigation query (e.g., 'Show me when the person enters the room')"
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Video Chunks (Auto-loaded)</label>
                        <textarea 
                            id="chunk-data" 
                            class="form-input" 
                            placeholder="Select a video above to automatically load its chunks..."
                            rows="8"
                            readonly
                        ></textarea>
                    </div>
                    
                    <button 
                        id="analyze-chunks-btn" 
                        class="btn btn-primary"
                        style="width: 100%;"
                        disabled
                    >
                        <i class="fas fa-brain"></i>
                        Analyze with LLM
                    </button>
                </div>
                
                <!-- Results Section -->
                <div>
                    <div id="chunk-analysis-results" style="display: none;">
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">
                            <i class="fas fa-bullseye"></i> Most Relevant Chunk
                        </h4>
                        
                        <div class="result-card" style="padding: 1.5rem; background-color: var(--secondary-color); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <strong style="font-size: 1.2rem;">Chunk #<span id="result-chunk-number">-</span></strong>
                                </div>
                                <div style="background-color: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">
                                    Duration: <span id="result-duration">-</span>s
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Time Range:</strong>
                                <div style="font-family: monospace; background-color: rgba(0,0,0,0.1); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                    <span id="result-start-time">-</span>s - <span id="result-end-time">-</span>s
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Content:</strong>
                                <div style="font-style: italic; padding: 0.75rem; background-color: rgba(0,0,0,0.1); border-radius: 4px; margin-top: 0.5rem;" id="result-caption">
                                    -
                                </div>
                            </div>
                            
                            <div id="llm-reasoning-section" style="display: none;">
                                <strong>LLM Analysis:</strong>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); padding: 0.75rem; background-color: rgba(0,0,0,0.1); border-radius: 4px; margin-top: 0.5rem;" id="llm-reasoning">
                                    -
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chunk-analysis-loading" style="display: none; text-align: center; padding: 3rem;">
                        <i class="fas fa-brain fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                        <p style="margin-top: 1rem;">LLM analyzing chunks...</p>
                    </div>
                    
                    <div id="chunk-analysis-placeholder" style="text-center: center; color: var(--text-secondary); padding: 3rem;">
                        <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Enter your query and chunk data</p>
                        <p style="font-size: 0.875rem;">LLM will determine the most relevant chunk</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Temporal Analysis Visualization -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-timeline nav-icon"></i>
                Temporal Analysis
            </div>
            <div class="card-subtitle">Timeline of video understanding and query patterns</div>
        </div>
        <div class="card-body">
            <div id="temporal-visualization">
                <div class="text-center" style="color: var(--text-secondary); padding: 3rem;">
                    <i class="fas fa-clock" style="font-size: 4rem; opacity: 0.3;"></i>
                    <p style="margin-top: 1rem; font-size: 1.1rem;">No temporal data available</p>
                    <p style="font-size: 0.875rem;">Process a video and ask temporal questions to see timeline analysis</p>
                    
                    <div class="mt-3" style="max-width: 500px; margin: 0 auto;">
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">
                            <strong>Example queries:</strong><br>
                            "What happens at 30 seconds?" â€¢ "Show me the action sequence" â€¢ "Timeline of events"
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Information -->
    <div class="grid grid-2 mt-4">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-brain nav-icon"></i>
                    Model Information
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-2">
                    <div>
                        <strong>Model:</strong><br>
                        <span style="color: var(--text-secondary);">InternVideo2.5 Chat 8B</span>
                    </div>
                    <div>
                        <strong>Parameters:</strong><br>
                        <span style="color: var(--text-secondary);">8.4 Billion</span>
                    </div>
                    <div>
                        <strong>Quantization:</strong><br>
                        <span style="color: var(--text-secondary);">8-bit (BitsAndBytes)</span>
                    </div>
                    <div>
                        <strong>Precision:</strong><br>
                        <span style="color: var(--text-secondary);">Float16 Compute</span>
                    </div>
                    <div>
                        <strong>Attention:</strong><br>
                        <span style="color: var(--text-secondary);">Flash Attention 2.8.3</span>
                    </div>
                    <div>
                        <strong>Context:</strong><br>
                        <span style="color: var(--text-secondary);">Long & Rich (LRC)</span>
                    </div>
                </div>

                <div class="mt-4" style="padding: 1rem; background-color: var(--secondary-color); border-radius: 8px;">
                    <div style="font-size: 0.875rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>ðŸš€ Optimizations:</strong>
                        </div>
                        <ul style="margin-left: 1rem; font-size: 0.8rem;">
                            <li>Singleton architecture for memory efficiency</li>
                            <li>Enhanced video preprocessing with decord</li>
                            <li>Adaptive hierarchical token compression</li>
                            <li>Dense vision task annotations (TPO)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-cog nav-icon"></i>
                    System Configuration
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-2">
                    <div>
                        <strong>GPU:</strong><br>
                        <span style="color: var(--text-secondary);">RTX 4090 24GB</span>
                    </div>
                    <div>
                        <strong>CUDA:</strong><br>
                        <span style="color: var(--text-secondary);">12.4</span>
                    </div>
                    <div>
                        <strong>PyTorch:</strong><br>
                        <span style="color: var(--text-secondary);">2.4.1+cu124</span>
                    </div>
                    <div>
                        <strong>Platform:</strong><br>
                        <span style="color: var(--text-secondary);">Linux (RunPod)</span>
                    </div>
                    <div>
                        <strong>Max Frames:</strong><br>
                        <span style="color: var(--text-secondary);">160 (8-bit mode)</span>
                    </div>
                    <div>
                        <strong>Max FPS:</strong><br>
                        <span style="color: var(--text-secondary);">5.0 sampling</span>
                    </div>
                </div>

                <div class="mt-4">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Model Status:</strong>
                        <span class="status-indicator status-success">Online</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <strong>System Health:</strong>
                        <span class="status-indicator status-success">Optimal</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Comparison -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-balance-scale nav-icon"></i>
                Quantization Comparison
            </div>
            <div class="card-subtitle">Performance differences across precision levels</div>
        </div>
        <div class="card-body">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: var(--secondary-color);">
                            <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border-color);">Mode</th>
                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Max Frames</th>
                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Memory Usage</th>
                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Load Time</th>
                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Quality</th>
                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);"><strong>BF16 (Baseline)</strong></td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">48</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">~20GB</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">4s</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">100%</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">
                                <span class="status-indicator status-warning">Available</span>
                            </td>
                        </tr>
                        <tr style="background-color: #f0f9ff;">
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);"><strong>8-bit (Current)</strong></td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);"><strong>160</strong></td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);"><strong>~17GB</strong></td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">16s</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">98%</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">
                                <span class="status-indicator status-success">Active</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);"><strong>4-bit (Experimental)</strong></td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">200+</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">~12GB</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">20s</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">95%</td>
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">
                                <span class="status-indicator status-info">Testing</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-3" style="font-size: 0.875rem; color: var(--text-secondary);">
                <strong>Note:</strong> Current configuration optimized for RTX 4090 with 8-bit quantization provides the best balance of capacity and quality.
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mock data - in real app, this would come from backend
    function updateAnalyticsMockData() {
        // Simulate some processing history
        const historyEl = document.querySelector('#processing-history');
        
        // Check if there's actual session data
        // For now, show mock data
        setTimeout(() => {
            if (historyEl && historyEl.innerHTML.includes('No processing history')) {
                // Still no real data, show mock
                console.log('Loading mock analytics data...');
            }
        }, 1000);
    }
    
    updateAnalyticsMockData();
    
    // Chunk Analysis Functionality
    const analyzeBtn = document.getElementById('analyze-chunks-btn');
    const queryInput = document.getElementById('chunk-query');
    const chunkDataInput = document.getElementById('chunk-data');
    const videoSelector = document.getElementById('video-selector');
    const loadingDiv = document.getElementById('chunk-analysis-loading');
    const resultsDiv = document.getElementById('chunk-analysis-results');
    const placeholderDiv = document.getElementById('chunk-analysis-placeholder');
    
    // Load available videos on page load
    async function loadAvailableVideos() {
        try {
            const response = await fetch('/api/stored-captions');
            const data = await response.json();
            
            if (data.success && data.videos.length > 0) {
                videoSelector.innerHTML = '<option value="">Select a video with stored captions...</option>';
                
                data.videos.forEach(video => {
                    const option = document.createElement('option');
                    option.value = video.video_file;
                    option.textContent = `${video.video_file} (${video.total_frames} frames, ${new Date(video.created_at).toLocaleString()})`;
                    videoSelector.appendChild(option);
                });
            } else {
                videoSelector.innerHTML = '<option value="">No videos with captions found. Generate captions first.</option>';
            }
        } catch (error) {
            console.error('Error loading videos:', error);
            videoSelector.innerHTML = '<option value="">Error loading videos</option>';
        }
    }
    
    // Load video caption data when video is selected
    videoSelector.addEventListener('change', async function() {
        const videoFile = this.value;
        
        if (!videoFile) {
            chunkDataInput.value = '';
            chunkDataInput.placeholder = 'Select a video above to automatically load its chunks...';
            analyzeBtn.disabled = true;
            return;
        }
        
        try {
            const response = await fetch(`/api/video-caption/${encodeURIComponent(videoFile)}`);
            const data = await response.json();
            
            if (data.success) {
                // Format chunks for display
                let chunks = data.data.chunks || [];
                
                // If no chunks (streaming captions), create real 20-second chunks from full caption
                if (chunks.length === 0 && data.data.full_caption) {
                    const fullCaption = data.data.full_caption;
                    const totalFrames = data.data.total_frames || 140;
                    
                    // Calculate video duration assuming 4 FPS (frames per second)
                    const videoDuration = totalFrames / 4; // 4 FPS as you specified
                    
                    // Create 20-second chunks to match your processing
                    const chunkDuration = 20; // 20 seconds as you specified
                    const numChunks = Math.ceil(videoDuration / chunkDuration);
                    
                    // Split caption text roughly evenly across chunks, skip markdown headers
                    const captionParts = fullCaption.split(/\n\n+/)
                        .filter(part => part.trim().length > 10)
                        .filter(part => !part.startsWith('**') && !part.startsWith('#') && !part.includes('Video Summary'));
                    
                    chunks = [];
                    for (let i = 0; i < numChunks; i++) {
                        const startTime = i * chunkDuration;
                        const endTime = Math.min((i + 1) * chunkDuration, videoDuration);
                        
                        // Assign caption parts to chunks
                        const partIndex = Math.floor((captionParts.length * i) / numChunks);
                        const chunkCaption = captionParts[partIndex] || `Video segment ${i + 1} of ${numChunks}`;
                        
                        chunks.push({
                            caption: chunkCaption.trim(),
                            start_time: startTime,
                            end_time: endTime,
                            chunk_id: i + 1
                        });
                    }
                    
                    console.log(`Created ${chunks.length} real 20s chunks from ${totalFrames} frames at 4fps (${videoDuration.toFixed(1)}s video)`);
                }
                
                const formattedChunks = JSON.stringify(chunks, null, 2);
                chunkDataInput.value = formattedChunks;
                
                // Enable analyze button if we have chunks
                analyzeBtn.disabled = chunks.length === 0;
                
                showNotification(`Loaded ${chunks.length} chunks for ${videoFile}`, 'success');
            } else {
                chunkDataInput.value = '';
                chunkDataInput.placeholder = 'No chunks found for this video';
                analyzeBtn.disabled = true;
                showNotification('No chunks found for this video', 'warning');
            }
        } catch (error) {
            console.error('Error loading video caption:', error);
            chunkDataInput.value = '';
            chunkDataInput.placeholder = 'Error loading chunks';
            analyzeBtn.disabled = true;
            showNotification('Error loading video chunks', 'error');
        }
    });
    
    // Initialize videos on page load
    loadAvailableVideos();
    
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
            const query = queryInput.value.trim();
            const chunkDataText = chunkDataInput.value.trim();
            
            if (!query) {
                showNotification('Please enter an investigation query', 'error');
                return;
            }
            
            if (!chunkDataText) {
                showNotification('Please select a video to load chunks automatically', 'error');
                return;
            }
            
            let chunks;
            try {
                chunks = JSON.parse(chunkDataText);
                if (!Array.isArray(chunks)) {
                    throw new Error('Data must be an array of chunks');
                }
            } catch (e) {
                showNotification('Invalid JSON format in chunk data', 'error');
                return;
            }
            
            // Show loading state
            placeholderDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-brain fa-spin"></i> Analyzing...';
            
            try {
                const response = await fetch('/api/find-relevant-chunk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        chunks: chunks
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    document.getElementById('result-chunk-number').textContent = data.relevant_chunk_number;
                    document.getElementById('result-duration').textContent = data.chunk_details.duration.toFixed(1);
                    document.getElementById('result-start-time').textContent = data.chunk_details.start_time.toFixed(1);
                    document.getElementById('result-end-time').textContent = data.chunk_details.end_time.toFixed(1);
                    document.getElementById('result-caption').textContent = data.chunk_details.caption;
                    
                    // Show LLM reasoning if available
                    const reasoningSection = document.getElementById('llm-reasoning-section');
                    const reasoningText = document.getElementById('llm-reasoning');
                    if (data.chunk_details.llm_reasoning) {
                        reasoningText.textContent = data.chunk_details.llm_reasoning;
                        reasoningSection.style.display = 'block';
                    } else {
                        reasoningSection.style.display = 'none';
                    }
                    
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    
                    showNotification('Chunk analysis completed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Chunk analysis error:', error);
                showNotification('Error analyzing chunks: ' + error.message, 'error');
                
                loadingDiv.style.display = 'none';
                placeholderDiv.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analyze with LLM';
            }
        });
    }
    
    // Update stats periodically
    setInterval(() => {
        // This would update with real data from the backend
        // For now, just ensure the page is interactive
    }, 5000);
});
</script>