<!-- Video Analysis Page -->
<div id="analysis-page" class="page-content hidden">
    <div class="page-header">
        <h1 class="page-title">Video Caption Processor</h1>
        <p class="page-description">
            Professional chunk analysis and content processing workflow
        </p>
    </div>

    <div class="grid grid-2" style="gap: 1.5rem;">
        <!-- Left Panel: Video Selection & Query -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-search nav-icon"></i>
                    Query Configuration
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Processed Video:</label>
                    <select id="video-selector" class="form-select">
                        <option value="">Choose a video with captions...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Investigation Query:</label>
                    <textarea 
                        id="chunk-query" 
                        class="form-textarea" 
                        placeholder="Enter your investigation query..."
                        rows="4"
                    ></textarea>
                    <small style="color: var(--text-secondary);">Example: "Show me when the person enters the room"</small>
                </div>
                
                <div class="form-group" style="display: none;">
                    <label class="form-label">Chunk Data:</label>
                    <textarea 
                        id="chunk-data" 
                        class="form-textarea" 
                        placeholder="Select a video above to automatically load its chunks..."
                        rows="6"
                        style="font-family: monospace; font-size: 0.85rem;"
                        readonly
                    ></textarea>
                </div>
                
                <button 
                    id="analyze-chunks-btn" 
                    class="btn btn-primary w-full"
                    disabled
                >
                    <i class="fas fa-robot nav-icon"></i>
                    Analyze with GPT-4o mini
                </button>
            </div>
        </div>

        <!-- Right Panel: Results -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-bullseye nav-icon"></i>
                    Analysis Results
                </div>
            </div>
            <div class="card-body">
                <div id="chunk-analysis-results" style="display: none;">
                    <div class="result-card" style="padding: 1.5rem; background-color: var(--secondary-color); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <strong style="font-size: 1.2rem;">Chunk #<span id="result-chunk-number">-</span></strong>
                            </div>
                            <div style="background-color: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">
                                <span id="result-duration">-</span>s
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Time Range:</strong>
                            <div style="font-family: monospace; background-color: rgba(0,0,0,0.1); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                <span id="result-start-time">-</span>s - <span id="result-end-time">-</span>s
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Content:</strong>
                            <div style="padding: 0.75rem; background-color: rgba(0,0,0,0.1); border-radius: 4px; margin-top: 0.5rem;" id="result-caption">
                                -
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <div id="chunk-analysis-loading" style="display: none; text-align: center; padding: 3rem;">
                    <i class="fas fa-brain fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <p style="margin-top: 1rem;">Processing chunks...</p>
                </div>
                
                <div id="chunk-analysis-placeholder" style="text-align: center; color: var(--text-secondary); padding: 3rem;">
                    <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 1rem;">Enter your query above</p>
                    <p style="font-size: 0.875rem;">AI will find the most relevant content</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chunk Processing Workflow -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-layer-group nav-icon"></i>
                Chunk Processing Workflow
            </div>
        </div>
        <div class="card-body">
            <div class="workflow-steps">
                <div class="workflow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Upload Video</h4>
                        <p>Upload your video content to the Caption Generation page</p>
                    </div>
                </div>
                <div class="workflow-arrow">→</div>
                <div class="workflow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Generate Captions</h4>
                        <p>Process video into analyzable text chunks with timestamps</p>
                    </div>
                </div>
                <div class="workflow-arrow">→</div>
                <div class="workflow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Query Analysis</h4>
                        <p>Use AI to find the most relevant content based on your query</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mock data - in real app, this would come from backend
    function updateAnalyticsMockData() {
        // Simulate some processing history
        const historyEl = document.querySelector('#processing-history');
        
        // Check if there's actual session data
        // For now, show mock data
        setTimeout(() => {
            if (historyEl && historyEl.innerHTML.includes('No processing history')) {
                // Still no real data, show mock
                console.log('Loading mock analytics data...');
            }
        }, 1000);
    }
    
    updateAnalyticsMockData();
    
    // Chunk Analysis Functionality
    const analyzeBtn = document.getElementById('analyze-chunks-btn');
    const queryInput = document.getElementById('chunk-query');
    const chunkDataInput = document.getElementById('chunk-data');
    const videoSelector = document.getElementById('video-selector');
    const loadingDiv = document.getElementById('chunk-analysis-loading');
    const resultsDiv = document.getElementById('chunk-analysis-results');
    const placeholderDiv = document.getElementById('chunk-analysis-placeholder');
    
    // Load available videos on page load
    async function loadAvailableVideos() {
        try {
            const response = await fetch('/api/stored-captions');
            const data = await response.json();
            
            if (data.success && data.videos.length > 0) {
                videoSelector.innerHTML = '<option value="">Select a video with stored captions...</option>';
                
                data.videos.forEach(video => {
                    const option = document.createElement('option');
                    option.value = video.video_file;
                    option.textContent = `${video.video_file} (${video.total_frames} frames, ${new Date(video.created_at).toLocaleString()})`;
                    videoSelector.appendChild(option);
                });
            } else {
                videoSelector.innerHTML = '<option value="">No videos with captions found. Generate captions first.</option>';
            }
        } catch (error) {
            console.error('Error loading videos:', error);
            videoSelector.innerHTML = '<option value="">Error loading videos</option>';
        }
    }
    
    // Load video caption data when video is selected
    videoSelector.addEventListener('change', async function() {
        const videoFile = this.value;
        
        if (!videoFile) {
            chunkDataInput.value = '';
            chunkDataInput.placeholder = 'Select a video above to automatically load its chunks...';
            analyzeBtn.disabled = true;
            return;
        }
        
        try {
            const response = await fetch(`/api/video-caption/${encodeURIComponent(videoFile)}`);
            const data = await response.json();
            
            if (data.success) {
                // Format chunks for display
                let chunks = data.data.chunks || [];
                
                // If no chunks (streaming captions), create real 20-second chunks from full caption
                if (chunks.length === 0 && data.data.full_caption) {
                    const fullCaption = data.data.full_caption;
                    const totalFrames = data.data.total_frames || 140;
                    
                    // Calculate video duration assuming 4 FPS (frames per second)
                    const videoDuration = totalFrames / 4; // 4 FPS as you specified
                    
                    // Create 20-second chunks to match your processing
                    const chunkDuration = 20; // 20 seconds as you specified
                    const numChunks = Math.ceil(videoDuration / chunkDuration);
                    
                    // Split caption text more effectively across chunks
                    const cleanCaption = fullCaption.replace(/\*\*[^*]*\*\*/g, '').replace(/#[^\n]*/g, '').trim();
                    
                    // Split by sentences for better distribution
                    const sentences = cleanCaption.split(/[.!?]+/)
                        .filter(s => s.trim().length > 20)
                        .map(s => s.trim());
                    
                    chunks = [];
                    for (let i = 0; i < numChunks; i++) {
                        const startTime = i * chunkDuration;
                        const endTime = Math.min((i + 1) * chunkDuration, videoDuration);
                        
                        // Distribute sentences across chunks based on character position
                        const chunkStartChar = Math.floor((cleanCaption.length * i) / numChunks);
                        const chunkEndChar = Math.floor((cleanCaption.length * (i + 1)) / numChunks);
                        
                        // Get the relevant portion of the caption for this time chunk
                        const chunkText = cleanCaption.substring(chunkStartChar, chunkEndChar).trim();
                        const chunkCaption = chunkText || `Video segment ${i + 1} of ${numChunks} (${startTime}-${endTime}s)`;
                        
                        chunks.push({
                            caption: chunkCaption.trim(),
                            start_time: startTime,
                            end_time: endTime,
                            chunk_id: i + 1
                        });
                    }
                    
                    console.log(`Created ${chunks.length} real 20s chunks from ${totalFrames} frames at 4fps (${videoDuration.toFixed(1)}s video)`);
                }
                
                const formattedChunks = JSON.stringify(chunks, null, 2);
                chunkDataInput.value = formattedChunks;
                
                // Enable analyze button if we have chunks
                analyzeBtn.disabled = chunks.length === 0;
                
                showNotification(`Loaded ${chunks.length} chunks for ${videoFile}`, 'success');
            } else {
                chunkDataInput.value = '';
                chunkDataInput.placeholder = 'No chunks found for this video';
                analyzeBtn.disabled = true;
                showNotification('No chunks found for this video', 'warning');
            }
        } catch (error) {
            console.error('Error loading video caption:', error);
            chunkDataInput.value = '';
            chunkDataInput.placeholder = 'Error loading chunks';
            analyzeBtn.disabled = true;
            showNotification('Error loading video chunks', 'error');
        }
    });
    
    // Initialize videos on page load
    loadAvailableVideos();
    
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
            const query = queryInput.value.trim();
            const chunkDataText = chunkDataInput.value.trim();
            
            if (!query) {
                showNotification('Please enter an investigation query', 'error');
                return;
            }
            
            if (!chunkDataText) {
                showNotification('Please select a video to load chunks automatically', 'error');
                return;
            }
            
            let chunks;
            try {
                chunks = JSON.parse(chunkDataText);
                if (!Array.isArray(chunks)) {
                    throw new Error('Data must be an array of chunks');
                }
            } catch (e) {
                showNotification('Invalid JSON format in chunk data', 'error');
                return;
            }
            
            // Show loading state
            placeholderDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-robot fa-spin"></i> Analyzing with GPT-4o mini...';
            
            try {
                const response = await fetch('/api/find-relevant-chunk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        chunks: chunks
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    document.getElementById('result-chunk-number').textContent = data.relevant_chunk_number;
                    document.getElementById('result-duration').textContent = data.chunk_details.duration.toFixed(1);
                    document.getElementById('result-start-time').textContent = data.chunk_details.start_time.toFixed(1);
                    document.getElementById('result-end-time').textContent = data.chunk_details.end_time.toFixed(1);
                    document.getElementById('result-caption').textContent = data.chunk_details.caption;
                    
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    
                    showNotification('GPT-4o mini analysis completed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('GPT-4o mini analysis error:', error);
                showNotification('Error analyzing chunks: ' + error.message, 'error');
                
                loadingDiv.style.display = 'none';
                placeholderDiv.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-robot"></i> Analyze with GPT-4o mini';
            }
        });
    }
    
    // Update stats periodically
    setInterval(() => {
        // This would update with real data from the backend
        // For now, just ensure the page is interactive
    }, 5000);
});
</script>