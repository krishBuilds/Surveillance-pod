<!-- Caption Generation Page -->
<div id="caption-page" class="page-content hidden">
    <div class="page-header">
        <h1 class="page-title">Video Caption Generator</h1>
        <p class="page-description">
            Generate detailed captions for your videos
        </p>
    </div>

    <div class="grid grid-2" style="gap: 1.5rem;">
        <!-- Left Panel: Configuration -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-cog nav-icon"></i>
                    Configuration
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Video:</label>
                    <select id="caption-video-select" class="form-select">
                        <option value="">Choose a video...</option>
                    </select>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">FPS Sampling:</label>
                        <input type="number" id="caption-fps" class="form-input" 
                               value="1.0" min="0.1" max="3.0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Chunk Size (sec):</label>
                        <input type="number" id="chunk-size" class="form-input" 
                               value="60" min="30" max="180" step="10">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Processing Mode:</label>
                    <select id="processing-mode" class="form-select">
                        <option value="sequential">Sequential</option>
                        <option value="overlapping">Overlapping</option>
                        <option value="keyframe">Key Frame</option>
                        <option value="adaptive">Adaptive</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Caption Prompt:</label>
                    <textarea id="caption-prompt" class="form-textarea" rows="3" 
                              placeholder="Describe what to analyze...">Describe the sequence of events and actions in this video.</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Output Format:</label>
                    <select id="output-format-select" class="form-select">
                        <option value="paragraph">Paragraph</option>
                        <option value="timestamped">Timestamped</option>
                        <option value="detailed">Detailed</option>
                        <option value="summary">Summary</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Right Panel: Generation & Progress -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-play-circle nav-icon"></i>
                    Caption Generation
                </div>
            </div>
            <div class="card-body">
                <!-- Generate Button at top -->
                <button id="generate-caption-btn" class="btn btn-primary w-full mb-4">
                    <i class="fas fa-magic nav-icon"></i>
                    Generate Caption
                </button>

                <!-- Progress Section -->
                <div id="processing-progress" class="hidden">
                    <h4 style="font-size: 1rem; margin-bottom: 1rem;">Processing Progress</h4>
                    <div class="mb-3">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Progress</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-2" style="gap: 1rem; font-size: 0.875rem;">
                        <div>
                            <strong>Chunk:</strong> <span id="current-chunk">0 / 0</span>
                        </div>
                        <div>
                            <strong>Time:</strong> <span id="processing-time">00:00</span>
                        </div>
                        <div>
                            <strong>Frames:</strong> <span id="frames-processed">0</span>
                        </div>
                        <div>
                            <strong>Status:</strong> <span id="processing-status" style="color: var(--primary-color);">Ready</span>
                        </div>
                    </div>
                </div>

                <!-- Time Estimate (simplified) -->
                <div id="time-estimation-container" style="padding: 1rem; background-color: var(--secondary-color); border-radius: 8px; margin-top: 1rem;">
                    <div id="time-estimation" style="font-size: 0.875rem; color: var(--text-secondary);">
                        Select a video to see processing time estimate
                    </div>
                </div>

                <!-- Stop button (shown during processing) -->
                <button id="stop-caption-btn" class="btn btn-secondary w-full mt-3 hidden">
                    <i class="fas fa-stop nav-icon"></i>
                    Stop Processing
                </button>
            </div>
        </div>
    </div>

    <!-- Caption Results -->
    <div id="caption-results" class="hidden mt-4">
        <!-- Results will be populated by JavaScript -->
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // Video selection change - update time estimation
    document.querySelector('#caption-video-select')?.addEventListener('change', function() {
        updateTimeEstimation();
    });

    document.querySelector('#caption-fps')?.addEventListener('input', updateTimeEstimation);
    document.querySelector('#chunk-size')?.addEventListener('input', updateTimeEstimation);

    function updateTimeEstimation() {
        const videoSelect = document.querySelector('#caption-video-select');
        const fpsInput = document.querySelector('#caption-fps');
        const chunkInput = document.querySelector('#chunk-size');
        const estimationEl = document.querySelector('#time-estimation');

        if (!videoSelect.value) {
            estimationEl.textContent = 'Select a video to see processing time estimate';
            return;
        }

        // Mock calculation - in real app, this would be based on actual video duration
        const mockVideoDuration = 180; // seconds
        const fps = parseFloat(fpsInput.value) || 1.0;
        const chunkSize = parseInt(chunkInput.value) || 60;
        
        const chunks = Math.ceil(mockVideoDuration / chunkSize);
        const framesPerChunk = Math.min(160, fps * chunkSize);
        const processingTimePerChunk = framesPerChunk / 4.9; // 4.9 frames/second
        const totalTime = chunks * processingTimePerChunk;

        const minutes = Math.floor(totalTime / 60);
        const seconds = Math.ceil(totalTime % 60);
        estimationEl.innerHTML = `
            <strong>Estimated time:</strong> ${minutes > 0 ? minutes + ' min ' : ''}${seconds} sec<br>
            <small style="opacity: 0.8;">${chunks} chunks Ã— ${framesPerChunk} frames</small>
        `;
    }
});
</script>

<style>
/* Real-time caption generation styles */
.chunk-result {
    background: var(--secondary-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    animation: slideIn 0.3s ease-out;
}

.chunk-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.chunk-timing {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.chunk-content {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.9rem;
    line-height: 1.4;
}

.cleanup-msg {
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
    margin: 0.25rem 0;
}

.final-caption-header {
    margin-bottom: 1rem;
}

.final-caption-header h3 {
    margin: 0 0 0.5rem 0;
    color: var(--primary-color);
}

.caption-stats {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.final-caption-content {
    background: var(--background-color);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 1.5rem;
    font-size: 1rem;
    line-height: 1.6;
}

#live-chunks {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem;
    background: var(--background-color);
}

#progress-section {
    margin-bottom: 1rem;
}

#progress-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

/* Animation for new chunks */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive styles */
@media (max-width: 768px) {
    .chunk-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .chunk-timing {
        margin-top: 0.25rem;
    }
}
</style>