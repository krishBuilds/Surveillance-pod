<!-- Caption Generation Page -->
<div id="caption-page" class="page-content hidden">
    <div class="page-header">
        <h1 class="page-title">Video Caption Generator</h1>
        <p class="page-description">
            Generate detailed captions for entire videos using FPS-based sampling and chunk processing
        </p>
    </div>

    <div class="grid grid-2">
        <!-- Caption Generation Settings -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-closed-captioning nav-icon"></i>
                    Caption Settings
                </div>
                <div class="card-subtitle">Configure caption generation parameters</div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Video:</label>
                    <select id="caption-video-select" class="form-select">
                        <option value="">Loading videos...</option>
                    </select>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">FPS Sampling:</label>
                        <input type="number" id="caption-fps" class="form-input" 
                               value="1.0" min="0.1" max="3.0" step="0.1">
                        <small style="color: var(--text-secondary);">Frames per second to analyze (1.0+ recommended)</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Chunk Size (seconds):</label>
                        <input type="number" id="chunk-size" class="form-input" 
                               value="60" min="30" max="180" step="10">
                        <small style="color: var(--text-secondary);">Video segment duration</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Processing Mode:</label>
                    <select id="processing-mode" class="form-select">
                        <option value="sequential">Sequential Chunks</option>
                        <option value="overlapping">Overlapping Chunks</option>
                        <option value="keyframe">Key Frame Detection</option>
                        <option value="adaptive">Adaptive Sampling</option>
                    </select>
                    <small style="color: var(--text-secondary);">How to divide the video for processing</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Caption Prompt:</label>
                    <textarea id="caption-prompt" class="form-textarea" rows="3" 
                              placeholder="Describe the main sequence of events...">Describe the sequence of events and actions in this video. Include what happens, who is involved, and important movements or changes.</textarea>
                    <small style="color: var(--text-secondary);">Customize the AI prompt for caption generation</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Output Format:</label>
                    <div class="grid grid-2">
                        <label style="display: flex; align-items: center; font-size: 0.875rem;">
                            <input type="radio" name="output-format" value="paragraph" checked style="margin-right: 0.5rem;">
                            Paragraph Format
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.875rem;">
                            <input type="radio" name="output-format" value="timestamped" style="margin-right: 0.5rem;">
                            Timestamped Sections
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.875rem;">
                            <input type="radio" name="output-format" value="detailed" style="margin-right: 0.5rem;">
                            Detailed Breakdown
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.875rem;">
                            <input type="radio" name="output-format" value="summary" style="margin-right: 0.5rem;">
                            Summary + Details
                        </label>
                    </div>
                </div>

                <button id="generate-caption-btn" class="btn btn-primary w-full">
                    <i class="fas fa-magic nav-icon"></i>
                    Generate Caption
                </button>
            </div>
        </div>

        <!-- Processing Progress -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-line nav-icon"></i>
                    Processing Status
                </div>
            </div>
            <div class="card-body">
                <div id="processing-progress" class="hidden">
                    <div class="mb-3">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Progress</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-2">
                        <div>
                            <strong>Chunk:</strong> <span id="current-chunk">0 / 0</span>
                        </div>
                        <div>
                            <strong>Time:</strong> <span id="processing-time">00:00</span>
                        </div>
                        <div>
                            <strong>Frames:</strong> <span id="frames-processed">0</span>
                        </div>
                        <div>
                            <strong>Status:</strong> <span id="processing-status">Ready</span>
                        </div>
                    </div>
                </div>

                <!-- System Stats -->
                <div class="mt-3">
                    <h4 style="font-size: 1rem; margin-bottom: 1rem;">System Capabilities:</h4>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <div>üìä <strong>Max Frames:</strong> 160 per chunk (8-bit quantization)</div>
                        <div>‚ö° <strong>Processing Speed:</strong> ~4.9 frames/second</div>
                        <div>üß† <strong>Model:</strong> InternVideo2.5 Chat 8B</div>
                        <div>üíæ <strong>Memory:</strong> RTX 4090 24GB (~88% utilization)</div>
                        <div>üîß <strong>Optimization:</strong> Flash Attention 2.8.3</div>
                    </div>
                </div>

                <!-- Estimation -->
                <div class="mt-3" style="padding: 1rem; background-color: var(--secondary-color); border-radius: 8px;">
                    <h5 style="font-size: 0.875rem; margin-bottom: 0.5rem;">‚è±Ô∏è Time Estimation:</h5>
                    <div id="time-estimation" style="font-size: 0.75rem; color: var(--text-secondary);">
                        Select a video to see processing time estimate
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Caption Results -->
    <div id="caption-results" class="hidden mt-4">
        <!-- Results will be populated by JavaScript -->
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // Video selection change - update time estimation
    document.querySelector('#caption-video-select')?.addEventListener('change', function() {
        updateTimeEstimation();
    });

    document.querySelector('#caption-fps')?.addEventListener('input', updateTimeEstimation);
    document.querySelector('#chunk-size')?.addEventListener('input', updateTimeEstimation);

    function updateTimeEstimation() {
        const videoSelect = document.querySelector('#caption-video-select');
        const fpsInput = document.querySelector('#caption-fps');
        const chunkInput = document.querySelector('#chunk-size');
        const estimationEl = document.querySelector('#time-estimation');

        if (!videoSelect.value) {
            estimationEl.textContent = 'Select a video to see processing time estimate';
            return;
        }

        // Mock calculation - in real app, this would be based on actual video duration
        const mockVideoDuration = 180; // seconds
        const fps = parseFloat(fpsInput.value) || 1.0;
        const chunkSize = parseInt(chunkInput.value) || 60;
        
        const chunks = Math.ceil(mockVideoDuration / chunkSize);
        const framesPerChunk = Math.min(160, fps * chunkSize);
        const processingTimePerChunk = framesPerChunk / 4.9; // 4.9 frames/second
        const totalTime = chunks * processingTimePerChunk;

        estimationEl.innerHTML = `
            <div><strong>${chunks}</strong> chunks √ó <strong>${framesPerChunk}</strong> frames each</div>
            <div>Estimated time: <strong>${Math.ceil(totalTime / 60)} minutes ${Math.ceil(totalTime % 60)} seconds</strong></div>
            <div style="font-size: 0.7rem; opacity: 0.8;">Based on ${fps} FPS sampling and ${chunkSize}s chunks</div>
        `;
    }
});
</script>

<style>
/* Real-time caption generation styles */
.chunk-result {
    background: var(--secondary-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    animation: slideIn 0.3s ease-out;
}

.chunk-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.chunk-timing {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.chunk-content {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.9rem;
    line-height: 1.4;
}

.cleanup-msg {
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
    margin: 0.25rem 0;
}

.final-caption-header {
    margin-bottom: 1rem;
}

.final-caption-header h3 {
    margin: 0 0 0.5rem 0;
    color: var(--primary-color);
}

.caption-stats {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.final-caption-content {
    background: var(--background-color);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 1.5rem;
    font-size: 1rem;
    line-height: 1.6;
}

#live-chunks {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem;
    background: var(--background-color);
}

#progress-section {
    margin-bottom: 1rem;
}

#progress-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

/* Animation for new chunks */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive styles */
@media (max-width: 768px) {
    .chunk-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .chunk-timing {
        margin-top: 0.25rem;
    }
}
</style>